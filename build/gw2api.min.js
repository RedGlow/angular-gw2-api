angular.module("redglow.gw2api",[]).factory("Now",function(){return{value:function(){return new Date}}}).provider("GW2API",function(){var provider=this;return provider.itemsEntrySecondsDuration=86400,provider.recipesEntrySecondsDuration=86400,provider.listingsEntrySecondsDuration=60,provider.currenciesEntrySecondsDuration=86400,provider.achievementsEntrySecondsDuration=86400,provider.timeoutDelay=250,provider.language=null,provider.localStorageFactory=function($window){function isStorageSupported(){var supported;try{supported=$window.localStorage}catch(err){supported=!1}if(supported){var key="__"+Math.round(1e7*Math.random());try{localStorage.setItem(key,key),localStorage.removeItem(key)}catch(err){supported=!1}}return supported}function key(familyKey,idKey){return"gw2api-"+familyKey+"-"+idKey}return isStorageSupported()?{get:function(familyKey,idKey){var item=$window.localStorage.getItem(key(familyKey,idKey));if(null===item)return void 0;var returnValue=angular.fromJson(item);return returnValue.timestamp=new Date(returnValue.timestamp),returnValue},set:function(familyKey,idKey,value){return $window.localStorage.setItem(key(familyKey,idKey),angular.toJson(value))},del:function(familyKey,idKey){$window.localStorage.removeItem(key(familyKey,idKey))}}:!1},provider.cacheFactories=[provider.localStorageFactory],this.$get=function($injector,$q,$http,$log,$timeout,$filter,Now){function produceRequestsEntry(name,entrySecondsDuration,endpoint){return{name:name,queue:{},queued:{},entrySecondsDuration:entrySecondsDuration,timerIsStarted:!1,endpoint:endpoint}}function runRequests(key){var request=requests[key];request.timerIsStarted=!1;for(var queueIds=Object.keys(request.queue),i=0;i<queueIds.length;i++){var id=queueIds[i],deferreds=request.queue[id];request.queued[id]=[],Array.prototype.push.apply(request.queued[id],deferreds)}request.queue={};var ids=queueIds.join(","),url=request.endpoint+"?ids="+ids;provider.language&&(url+="&lang=",url+=provider.language),$http.get(url).then(function(response){var i,item,id,data=response.data,now=Now.value();for(i=0;i<data.length;i++)item=data[i],id=item.id,mainCacheObject.set(request.name,id,{timestamp:now,value:item,isRejection:!1});var queueId,queueRow,notId=function(value){return value!=id};for(i=0;i<data.length;i++){item=data[i],id=item.id,queueRow=request.queued[id];for(var j=0;j<queueRow.length;j++)queueRow[j].resolve(item),numRunningRequests--;delete request.queued[id],queueIds=$filter("filter")(queueIds,notId)}for(i=0;i<queueIds.length;i++){queueId=queueIds[i],queueRow=request.queued[queueId];var returnValue={text:"no such id"};mainCacheObject.set(request.name,queueId,{timestamp:now,value:returnValue,isRejection:!0});for(var jj=0;jj<queueRow.length;jj++)queueRow[jj].reject(returnValue),numRunningRequests--;delete request.queued[queueId]}},function(err){var i,queueId,queueRow,j;if(err.data&&err.data.text&&("all ids provided are invalid"==err.data.text||"no such id"==err.data.text)){var now=Now.value();for(i=0;i<queueIds.length;i++){queueId=queueIds[i],queueRow=request.queued[queueId];var returnValue={text:"no such id"};for(mainCacheObject.set(request.name,queueId,{timestamp:now,value:returnValue,isRejection:!0}),j=0;j<queueRow.length;j++)queueRow[j].reject(returnValue),numRunningRequests--;delete request.queued[queueId]}}else for(i=0;i<queueIds.length;i++){for(queueId=queueIds[i],queueRow=request.queued[queueId],j=0;j<queueRow.length;j++)queueRow[j].reject(err),numRunningRequests--;delete request.queued[queueId]}})}function isInt(value){return!isNaN(value)&&parseInt(Number(value))===value&&!isNaN(parseInt(value,10))}function enqueue(key,id){if(!isInt(id))return $q.reject("Not an id:",id);id=parseInt(id);var request=requests[key],cacheEntry=mainCacheObject.get(request.name,id);if(void 0!==cacheEntry){var cacheDate=cacheEntry.timestamp,now=Now.value(),delta=(now-cacheDate)/1e3;if(delta<=request.entrySecondsDuration)return cacheEntry.isRejection?$q.reject(cacheEntry.value):$q.when(cacheEntry.value);mainCacheObject.del(request.name,id)}var deferred=$q.defer();numRunningRequests++;var queuedEntry=request.queued[id];return void 0!==queuedEntry?queuedEntry.push(deferred):(void 0===request.queue[id]&&(request.queue[id]=[]),request.queue[id].push(deferred),request.timerIsStarted||($timeout(function(){runRequests(key)},provider.timeoutDelay),request.timerIsStarted=!0)),deferred.promise}function straightCall(url,token){return numRunningRequests++,token&&(url=[url,"?access_token=",token].join("")),$http({method:"GET",url:url}).then(function(response){return response.data})["finally"](function(){numRunningRequests--})}for(var mainCacheObject=null,cacheFactoryIndex=0;cacheFactoryIndex<provider.cacheFactories.length;cacheFactoryIndex++){var cacheFactory=provider.cacheFactories[cacheFactoryIndex],obtainedCache=$injector.invoke(cacheFactory);if(obtainedCache){mainCacheObject=obtainedCache;break}}if(!mainCacheObject){var mainCache={},getMainCacheFamilyEntry=function(familyKey){return mainCache[familyKey]||(mainCache[familyKey]={}),mainCache[familyKey]};mainCacheObject={get:function(familyKey,idKey){return getMainCacheFamilyEntry(familyKey)[idKey]},set:function(familyKey,idKey,value){getMainCacheFamilyEntry(familyKey)[idKey]=value},del:function(familyKey,idKey){var familyEntry=getMainCacheFamilyEntry(familyKey);delete familyEntry[idKey]}}}var numRunningRequests=0,requests={items:produceRequestsEntry("items",provider.itemsEntrySecondsDuration,"https://api.guildwars2.com/v2/items"),listings:produceRequestsEntry("listings",provider.listingsEntrySecondsDuration,"https://api.guildwars2.com/v2/commerce/listings"),recipes:produceRequestsEntry("recipes",provider.recipesEntrySecondsDuration,"https://api.guildwars2.com/v2/recipes"),currencies:produceRequestsEntry("currencies",provider.currenciesEntrySecondsDuration,"https://api.guildwars2.com/v2/currencies"),achievements:produceRequestsEntry("achievements",provider.achievementsEntrySecondsDuration,"https://api.guildwars2.com/v2/achievements")};return{getItem:function(id){return enqueue("items",id)},getListing:function(id){return enqueue("listings",id)},getRecipe:function(id){return enqueue("recipes",id)},getTokenInfo:function(token){return straightCall("https://api.guildwars2.com/v2/tokeninfo",token)},getBank:function(token){return straightCall("https://api.guildwars2.com/v2/account/bank",token)},getMaterials:function(token){return straightCall("https://api.guildwars2.com/v2/account/materials",token)},getCharacters:function(token){return straightCall("https://api.guildwars2.com/v2/characters",token)},getCharacter:function(characterName,token){return straightCall("https://api.guildwars2.com/v2/characters/"+characterName,token)},getRecipeIdsByOutput:function(outputId){return straightCall("https://api.guildwars2.com/v2/recipes/search?output="+outputId)},getNumRunningRequests:function(){return numRunningRequests},getTimeoutDelay:function(){return provider.timeoutDelay},getItemsEntrySecondsDuration:function(){return provider.itemsEntrySecondsDuration},getCurrencies:function(){return straightCall("https://api.guildwars2.com/v2/currencies")},getCurrency:function(id){return enqueue("currencies",id)},getWallet:function(token){return straightCall("https://api.guildwars2.com/v2/account/wallet",token)},getAchievements:function(){return straightCall("https://api.guildwars2.com/v2/achievements")},getAchievement:function(id){return enqueue("achievements",id)},getAccountAchievements:function(token){return straightCall("https://api.guildwars2.com/v2/account/achievements",token)}}},this});